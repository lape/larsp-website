<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!-- Begin Bridgetown SEO tag v6.0.0 -->
<title>Ruby on Rails with Docker in production | larsp.dev</title>
<meta property="og:title" content="Ruby on Rails with Docker in production" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Minimal Docker production setup for Ruby on Rails." />
<meta property="og:description" content="Minimal Docker production setup for Ruby on Rails." />
<link rel="canonical" href="https://larsp.dev/rails/ruby-on-rails-docker-production/" />
<meta property="og:url" content="https://larsp.dev/rails/ruby-on-rails-docker-production/" />
<meta property="og:site_name" content="larsp.dev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-12T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ruby on Rails with Docker in production" />
<meta name="twitter:site" content="@lape" />
<!-- End Bridgetown SEO tag -->


<link type="application/atom+xml" rel="alternate" href="https://larsp.dev/feed.xml" title="larsp.dev" />
<link rel="stylesheet" href="/_bridgetown/static/index.ADFEGADE.css" />
<script src="/_bridgetown/static/index.BFEJNYGY.js" defer></script>
<script src="https://unpkg.com/feather-icons"></script>


  </head>
  <body class="post ">
    <header>
  <h2>larsp.dev</h2>
</header>

<nav>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about/">About</a></li>
    <li><a href="/posts/">Blog</a></li>
    <li><a href="/now/">Now</a></li>
  </ul>
</nav>


    <main>
      <h1>Ruby on Rails with Docker in production</h1>

<p>Docker is a fantastic tool that allows developers to create and deploy applications in a consistent and predictable way. It offers the ability to create clean separations between different applications, ensuring that developers can work on multiple projects without worrying about conflicting dependencies or software versions. Additionally, Docker provides a way to define specific versions of software and runtime environments, which ensures that the application runs consistently across different environments. This is particularly useful for testing and deployment, as it allows developers to replicate the environment across different platforms, making it easy to deploy the application to production without any surprises.</p>

<h3 id="dokku">Dokku</h3>

<p>Today we are lucky to have several nice options for containerized Rails deployment. Personally, I like the <a href="https://dokku.com">Dokku</a> hosting system. Think of Dokku as a mini-Heroku; it’s lightweight but certainly packs a punch in terms of functionality. Multi-host deployments are not (easily) possible with Dokku.</p>

<h3 id="mrsk">MRSK</h3>

<p>Developed by the Basecamp team and used for their Rails deployments (i.e. the HEY email service), this is a great option for multi-host setups. Imagine <a href="https://github.com/mrsked/mrsk ">MRSK</a> as Capistrano for Containers, it will provision your servers and deploy the software to it, including the right version of Ruby and other dependencies. That all lives in the Docker image now. You can boot a brand new Ubuntu (or whatever) server, add it to the list of servers in MRSK, and it’ll be auto-provisioned with Docker, ready to run.</p>

<h3 id="minimal-production-dockerfile">Minimal production Dockerfile</h3>

<p>The following is best thought of as a <em>minimal</em> Ruby on Rails Docker production setup. It can be further build on e.g. by using an incremental build process (with several layers).</p>

<p>Maybe not all three database clients MySQL/PostgreSQL/SQLite that are included in the Dockerfile are necessary for your application, so omit what isn’t needed.</p>

<p><img src="/images/venti-views-1cqIcrWFQBI-unsplash.jpg" alt="Container ship" />
<em>Photo by <a href="https://unsplash.com/@ventiviews?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Venti Views</a></em></p>

<h3 id="dockerfile">Dockerfile</h3>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ruby on Rails application in production mode</span>
<span class="k">FROM</span><span class="s"> ruby:3.2.2</span>
<span class="k">RUN </span>curl <span class="nt">-sL</span> https://deb.nodesource.com/setup_14.x | bash -
<span class="k">RUN </span>apt-get update <span class="nt">-qq</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>  apt-get <span class="nb">install</span> <span class="nt">-qq</span> <span class="nt">--no-install-recommends</span> <span class="se">\
</span>  nodejs <span class="se">\
</span>  mariadb-client <span class="se">\
</span>  postgresql-client <span class="se">\
</span>  sqlite3 <span class="se">\
</span>  <span class="o">&amp;&amp;</span> apt-get clean <span class="se">\
</span>  <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
<span class="k">RUN </span>npm <span class="nb">install</span> <span class="nt">-g</span> yarn
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">COPY</span><span class="s"> Gemfile Gemfile.lock ./</span>
<span class="k">RUN </span>gem <span class="nb">install </span>bundler
<span class="k">RUN </span>bundle config <span class="nb">set </span>force_ruby_platform <span class="nb">true</span>
<span class="k">RUN </span>bundle config <span class="nb">set</span> <span class="nt">--local</span> without <span class="s1">'development test'</span>
<span class="k">RUN </span>bundle <span class="nb">install</span> <span class="nt">--jobs</span> 20 <span class="nt">--retry</span> 5
<span class="k">ENV</span><span class="s"> RAILS_ENV production</span>
<span class="k">ENV</span><span class="s"> RACK_ENV production</span>
<span class="k">COPY</span><span class="s"> . ./</span>
<span class="k">RUN </span><span class="nv">SECRET_KEY_BASE</span><span class="o">=</span>1 <span class="se">\
</span>  bundle <span class="nb">exec </span>rails assets:precompile
<span class="k">EXPOSE</span><span class="s"> 3000</span>
<span class="k">CMD</span><span class="s"> bundle exec rails s -e production -p 3000</span>
</code></pre></div></div>

<p>Extend with a GitHub action to build on commit (similar to <a href="/webtech/bridgetown/">autobuilding this Bridgetown site</a>) and push the image to a repository like Docker Hub or Amazon ECR.</p>

<p>Combine with nginx or <a href="https://github.com/traefik/traefik/">Traefik</a> as load balancer/reverse proxy.</p>

<p>Using nginx an additional certbot container is needed to generate and renew Letsencrypt TLS certificates. Traefik will handle this by itself.</p>

<p>Another great option is to use the great <a href="https://fly.io/">fly.io</a> service, which runs your Docker image on <a href="https://firecracker-microvm.github.io/">Firecracker</a> microVMs on their global infrastructure.</p>

<p><a href="https://mailsnag.com/blog/optimized-ruby-dockerfile/">Mailsnag recently posted</a> a comprehensive Dockerfile for production.</p>


Comments? Contact me at <a href="https://ruby.social/@lape">@lape@ruby.social</a>

    </main>

    

    <!-- Feather icon font -->
    <script>feather.replace()</script>
  </body>
</html>
